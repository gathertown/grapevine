name: Run Acceptance Tests

on:
  pull_request:
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  run-acceptance-tests:
    if: ${{ github.event.label.name == 'run-acceptance-tests' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          # Install gh CLI (required for PR operations)
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          echo "GitHub CLI version: $(gh --version)"

      - name: Validate prerequisites
        id: validate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e

          # Check for devenv label
          LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')
          if ! echo "$LABELS" | grep -q "devenv"; then
            echo "::error::PR must have 'devenv' label for acceptance testing"
            exit 1
          fi

          # Check for test plan comment
          TEST_PLAN_ID=$(gh api "/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.body | contains("Generated Test Plan")) | .id' | head -n 1)
          if [ -z "$TEST_PLAN_ID" ]; then
            echo "::error::No test plan found. Please wait for test plan generation."
            exit 1
          fi

          echo "Prerequisites validated"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install jq for JSON processing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude Code version: $(claude --version)"

      - name: Configure Claude Code MCP servers
        env:
          BROWSERBASE_API_KEY: ${{ secrets.BROWSERBASE_API_KEY }}
          BROWSERBASE_PROJECT_ID: ${{ secrets.BROWSERBASE_PROJECT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Build MCP config file for --mcp-config flag
          # Note: ~/.claude.json is NOT the correct location for CI
          # Claude Code requires --mcp-config flag to load MCP servers in headless mode
          jq -n \
            --arg bb_api_key "${BROWSERBASE_API_KEY}" \
            --arg bb_project_id "${BROWSERBASE_PROJECT_ID}" \
            --arg openai_key "${OPENAI_API_KEY}" \
            '{
              mcpServers: {
                browserbase: {
                  command: "npx",
                  args: [
                    "-y",
                    "@browserbasehq/mcp-server-browserbase",
                    "--modelName",
                    "openai/gpt-4o",
                    "--modelApiKey",
                    $openai_key
                  ],
                  env: {
                    BROWSERBASE_API_KEY: $bb_api_key,
                    BROWSERBASE_PROJECT_ID: $bb_project_id
                  }
                }
              }
            }' > /tmp/mcp-config.json

          echo "MCP Configuration created:"
          cat /tmp/mcp-config.json

      - name: Verify MCP server setup
        run: |
          echo "Verifying MCP server configuration..."
          if [ ! -f /tmp/mcp-config.json ]; then
            echo "::error::MCP config file (/tmp/mcp-config.json) not found"
            exit 1
          fi

          # Check if BrowserBase MCP is configured with correct package
          if ! grep -q "@browserbasehq/mcp-server-browserbase" /tmp/mcp-config.json; then
            echo "::error::BrowserBase MCP not found in configuration or wrong package name"
            exit 1
          fi

          # Verify required environment variables are present in config
          if ! grep -q "BROWSERBASE_API_KEY" /tmp/mcp-config.json; then
            echo "::error::BROWSERBASE_API_KEY not found in MCP configuration"
            exit 1
          fi

          if ! grep -q "BROWSERBASE_PROJECT_ID" /tmp/mcp-config.json; then
            echo "::error::BROWSERBASE_PROJECT_ID not found in MCP configuration"
            exit 1
          fi

          echo "âœ… MCP configuration verified"
          echo "Config preview:"
          cat /tmp/mcp-config.json | jq '.mcpServers.browserbase'

      - name: Generate execution prompt
        id: prompt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DEVENV_ADMIN_URL: https://cc-devenv-${{ github.event.pull_request.number }}.stg.getgrapevine.ai
          DEVENV_MCP_URL: https://mcp-cc-devenv-${{ github.event.pull_request.number }}.stg.getgrapevine.ai
          TEST_USER_EMAIL: ${{ secrets.VERIFICATION_LOOP_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.VERIFICATION_LOOP_TEST_USER_PASSWORD }}
        run: |
          set -e

          # Fetch PR details
          PR_URL=$(gh pr view "$PR_NUMBER" --json url --jq '.url')
          PR_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body')

          # Find Linear link (use POSIX character class for compatibility)
          LINEAR_URL=$(echo "$PR_BODY" | grep -oE 'https?://linear\.app/[^[:space:])]+' | head -n 1 || true)
          LINEAR_URL=${LINEAR_URL:-"Not found"}

          # Fetch test plan and save to file to avoid shell escaping issues
          # Use jq to select first matching comment and extract full body (handles multi-line content)
          gh api "/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq '([.[] | select(.body | contains("Generated Test Plan"))][0].body // empty)' > /tmp/test_plan.txt

          # Build the prompt using echo statements to avoid YAML parsing issues with heredocs
          {
            echo "=== PREAMBLE ==="
            echo "You are a professional test bot. You will be given a Linear ticket, a link to a PR that fixes/satisfies the ticket, and a test plan that outlines how to ensure the PR works as expected."
            echo ""
            echo "A developer environment has been created for you to test this PR, and the URL to the admin site is provided below. Use this environment for all Grapevine interaction and don't leave it unless given explicit instructions to do so."
            echo ""
            echo "Many PRs require authentication to test properly. If you wish to log into the Grapevine admin site, you can do so with the following credentials:"
            echo ""
            echo "Username: ${TEST_USER_EMAIL}"
            echo "Password: ${TEST_USER_PASSWORD}"
            echo ""
            echo "The admin site also allows you to issue API keys which are useful for testing MCP or other API calls. To generate an API key:"
            echo ""
            echo "1. Navigate to the admin site and log in."
            echo "2. Go to the API Keys page (nav is on the left)."
            echo "3. Create a new API key. Name it whatever you want, but make sure \"Verification Agent\" is somewhere in the name."
            echo "4. Copy the API key. This key can be used in the header of API requests: \`Authorization: Bearer <GRAPEVINE_API_KEY>\`."
            echo ""
            echo "=== RESOURCES ==="
            echo "Linear Ticket: ${LINEAR_URL}"
            echo "Github PR: ${PR_URL}"
            echo "Developer Environment Admin UI: ${DEVENV_ADMIN_URL}"
            echo "Developer Environment Admin Backend API: ${DEVENV_ADMIN_URL}/api"
            echo "Developer Environment MCP Server: ${DEVENV_MCP_URL}"
            echo ""
            echo "If links in the instructions mention localhost:8000, use the developer environment URLs instead."
            echo ""
            echo "=== INSTRUCTIONS ==="
            cat /tmp/test_plan.txt
            echo ""
            echo "=== EXECUTION MODE ==="
            echo "You have permission to run commands and HTTP calls. Execute every test case above against the provided environment. Do not stop at review; run the steps and report results. If a step fails, continue with the remaining tests and note the failures. Use the provided dev environment URLs instead of localhost."
            echo ""
            echo "**IMPORTANT: For all web UI testing, you MUST use the BrowserBase MCP tools (mcp__browserbase__*). DO NOT attempt to use local browsers or other browser automation tools. The BrowserBase MCP server has been configured and is available for your use.**"
            echo ""
            echo "**LOGIN INSTRUCTIONS: When using browserbase_stagehand_act to type credentials, include the actual credential value directly in the action string. Do NOT use the variables parameter. For example, use action: \"Type 'mypassword123' in the password field\" rather than using variables.**"
            echo ""
            echo "After completing all tests, provide a summary in this format:"
            echo ""
            echo "## Test Results Summary"
            echo ""
            echo "| Test Case | Status | Notes |"
            echo "|-----------|--------|-------|"
            echo "| [Name] | PASS/FAIL | [Brief notes] |"
            echo ""
            echo "### Overall Result: PASS/FAIL"
            echo ""
            echo "[Any additional observations or recommendations]"
          } > /tmp/execution_prompt.txt

          echo "Prompt generated successfully"

      - name: Post starting comment
        id: post_starting_comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          {
            echo "## ðŸ¤– Acceptance Test Started"
            echo ""
            echo "Running automated acceptance tests using Claude Code..."
            echo ""
            echo "This may take several minutes. Results will be posted when complete."
          } > /tmp/starting_comment.txt
          # Use gh api to create comment and capture the ID (gh pr comment doesn't support --json)
          COMMENT_ID=$(gh api -X POST "/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            -f body="$(cat /tmp/starting_comment.txt)" \
            --jq '.id')
          echo "comment_id=$COMMENT_ID" >> "$GITHUB_OUTPUT"

      - name: Setup non-root user for Claude Code (if needed)
        run: |
          # Claude Code refuses --dangerously-skip-permissions when running as root
          # GitHub Actions runs as non-root by default, but act (local testing) runs as root

          if [ "$(id -u)" -eq 0 ]; then
            echo "Running as root - creating non-root user for Claude Code"
            useradd -m -s /bin/bash testrunner

            # Copy MCP config to testrunner accessible location
            cp /tmp/mcp-config.json /home/testrunner/mcp-config.json
            chown testrunner:testrunner /home/testrunner/mcp-config.json

            # Copy execution prompt
            cp /tmp/execution_prompt.txt /home/testrunner/execution_prompt.txt
            chown testrunner:testrunner /home/testrunner/execution_prompt.txt

            # Give testrunner access to workspace
            chown -R testrunner:testrunner "${GITHUB_WORKSPACE}"

            {
              echo "CLAUDE_USER=testrunner"
              echo "PROMPT_FILE=/home/testrunner/execution_prompt.txt"
              echo "MCP_CONFIG_FILE=/home/testrunner/mcp-config.json"
              echo "USE_SU=true"
            } >> "$GITHUB_ENV"
            echo "âœ… Non-root user configured"
          else
            echo "Already running as non-root user: $(whoami)"
            {
              echo "CLAUDE_USER=$(whoami)"
              echo "PROMPT_FILE=/tmp/execution_prompt.txt"
              echo "MCP_CONFIG_FILE=/tmp/mcp-config.json"
              echo "USE_SU=false"
            } >> "$GITHUB_ENV"
            echo "âœ… Using current user for Claude Code"
          fi

      - name: Run acceptance tests
        id: run_tests
        timeout-minutes: 30
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BROWSERBASE_API_KEY: ${{ secrets.BROWSERBASE_API_KEY }}
          BROWSERBASE_PROJECT_ID: ${{ secrets.BROWSERBASE_PROJECT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TEST_USER_EMAIL: ${{ secrets.VERIFICATION_LOOP_TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.VERIFICATION_LOOP_TEST_USER_PASSWORD }}
        run: |
          set -e
          set -o pipefail

          # Register secrets for masking in logs
          echo "::add-mask::${TEST_USER_EMAIL}"
          echo "::add-mask::${TEST_USER_PASSWORD}"

          echo "Starting Claude Code..."
          echo "Prompt file: ${PROMPT_FILE}"
          echo "MCP config file: ${MCP_CONFIG_FILE}"
          echo "Prompt length: $(wc -c < "${PROMPT_FILE}" 2>/dev/null || echo 'unknown') bytes"
          echo "Note: Full prompt contains credentials and is not displayed in logs"
          echo ""
          echo "================================"
          echo "Running tests..."
          echo "================================"
          echo ""

          # Find where node and claude were installed
          NODE_PATH=$(which node)
          NODE_DIR=$(dirname "$NODE_PATH")
          CLAUDE_PATH=$(which claude)
          echo "Node path: $NODE_PATH"
          echo "Claude Code path: $CLAUDE_PATH"
          echo "Running as user: ${CLAUDE_USER}"
          echo "Use su: ${USE_SU}"

          # Run Claude Code (as different user if we created one, or current user otherwise)
          if [ "${USE_SU}" = "true" ]; then
            # Running as root (act) - use su to switch to testrunner
            echo "Running Claude Code via su to ${CLAUDE_USER}..."
            su - "${CLAUDE_USER}" -c "
              export ANTHROPIC_API_KEY='${ANTHROPIC_API_KEY}'
              export BROWSERBASE_API_KEY='${BROWSERBASE_API_KEY}'
              export BROWSERBASE_PROJECT_ID='${BROWSERBASE_PROJECT_ID}'
              export OPENAI_API_KEY='${OPENAI_API_KEY}'
              export PATH='${NODE_DIR}:/usr/local/bin:/usr/bin:/bin'

              cd \"${GITHUB_WORKSPACE}\"

              echo \"Node version: \$(node --version)\"
              echo \"Claude path: ${CLAUDE_PATH}\"
              echo \"MCP config: ${MCP_CONFIG_FILE}\"

              \"${CLAUDE_PATH}\" -p \"\$(cat \"${PROMPT_FILE}\")\" \
                --mcp-config \"${MCP_CONFIG_FILE}\" \
                --output-format json \
                --model claude-sonnet-4-20250514 \
                --dangerously-skip-permissions \
                2>&1 | tee /tmp/full_conversation.json
            "
          else
            # Running as non-root (GitHub Actions) - run directly
            echo "Running Claude Code as current user..."
            echo "Node version: $(node --version)"
            echo "Claude path: ${CLAUDE_PATH}"
            echo "MCP config: ${MCP_CONFIG_FILE}"

            "${CLAUDE_PATH}" -p "$(cat "${PROMPT_FILE}")" \
              --mcp-config "${MCP_CONFIG_FILE}" \
              --output-format json \
              --model claude-sonnet-4-20250514 \
              --dangerously-skip-permissions \
              2>&1 | tee /tmp/full_conversation.json
          fi

          # Make conversation log accessible
          chmod 644 /tmp/full_conversation.json 2>/dev/null || true

          # Extract final response for summary
          # With --output-format json, the output is a single JSON object with a "result" field
          echo "Extracting final response..."
          if jq -e -r '.result' /tmp/full_conversation.json 2>/dev/null > /tmp/test_results.txt && [ -s /tmp/test_results.txt ]; then
            echo "Extracted result from conversation"
          else
            echo "Failed to extract test results from JSON output"
            echo "Failed to extract test results. Check the conversation log artifact." > /tmp/test_results.txt
          fi

          echo "Tests completed"

      - name: Upload conversation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-conversation-log
          path: /tmp/full_conversation.json
          retention-days: 7 # Reduced retention due to sensitive data

      - name: Post results comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMENT_ID: ${{ steps.post_starting_comment.outputs.comment_id }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          set -e

          if [ -f /tmp/test_results.txt ] && [ -s /tmp/test_results.txt ]; then
            # Build the comment body, writing to file to avoid escaping issues
            {
              echo "## ðŸ¤– Acceptance Test Results"
              echo ""
              cat /tmp/test_results.txt
              echo ""
              echo "---"
              echo "_Tested by Claude Code at $(date -u +"%Y-%m-%d %H:%M:%S UTC")_ Â· [View logs](https://github.com/${REPO}/actions/runs/${RUN_ID})"
            } > /tmp/comment_body.txt

            # Update the original comment with results
            if [ -n "$COMMENT_ID" ]; then
              gh api -X PATCH "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
                -f body="$(cat /tmp/comment_body.txt)"
            else
              # Fallback: create new comment if we somehow lost the ID
              gh pr comment "$PR_NUMBER" --body-file /tmp/comment_body.txt
            fi
          else
            {
              echo "## ðŸ¤– Acceptance Test Results"
              echo ""
              echo "No test results were generated. Check the workflow logs for details."
              echo ""
              echo "ðŸ“‹ [View workflow run](https://github.com/${REPO}/actions/runs/${RUN_ID})"
            } > /tmp/error_comment.txt
            if [ -n "$COMMENT_ID" ]; then
              gh api -X PATCH "/repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
                -f body="$(cat /tmp/error_comment.txt)"
            else
              gh pr comment "$PR_NUMBER" --body-file /tmp/error_comment.txt
            fi
          fi

name: Grapevine PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/pr-review-requirements.txt

      - name: Run PR review tool
        id: pr_review
        run: |
          python -u .github/scripts/call_pr_review_tool.py \
            "$PR_NUMBER" \
            --repo "$REPO" \
            --output-json review_result.json \
            | tee review_output.txt
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          MCP_URL: ${{ vars.GRAPEVINE_MCP_URL || 'http://localhost:8000' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MCP_API_KEY: ${{ secrets.GRAPEVINE_MCP_API_KEY }}

      - name: Post review to PR
        if: success() && hashFiles('review_result.json') != ''
        run: |
          python .github/scripts/post_pr_review.py \
            --pr-number "$PR_NUMBER" \
            --repo "$REPO" \
            --review-file review_result.json
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ADMIN_BACKEND_URL: ${{ vars.ADMIN_BACKEND_URL }}
          GRAPEVINE_API_KEY: ${{ secrets.GRAPEVINE_MCP_API_KEY }}

      - name: Send to Slack
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.GRAPEVINE_REVIEWER_SLACK_BOT_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          python .github/scripts/send_slack_review.py \
            --review-file review_output.txt \
            --pr-url "$PR_URL" \
            --pr-number "$PR_NUMBER" \
            --pr-title "$PR_TITLE" \
            --pr-author "$PR_AUTHOR" \
            --channel "C0A1HMDP63E" \
            --team-domain "${{ vars.SLACK_TEAM_DOMAIN || 'gather-town' }}"

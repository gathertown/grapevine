# This workflow is primarily concerned with build docker images and
# triggering ArgoCD. Devenv creation/deployment logic is entirely on the
# ArgoCD side at gathertown/k8s-argcocd.
name: Deploy to Devenv

on:
  pull_request:
    types: [opened, labeled, reopened, synchronize]
    branches-ignore:
      - 'deploy-queue/**'
      - 'deploy-queue-hotfix/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read # Clone repo
  packages: read # Get npm packages
  pull-requests: write # Comment on PR
  checks: write # Write devenv check run
  id-token: write

jobs:
  set-pending-status:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'devenv') }}

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      - name: Update Status
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW_ID: ${{ github.run_id }}
        run: ./.github/scripts/notify-devenv.sh

  build-docker-images:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'devenv') }}

    uses: ./.github/workflows/build-docker-images.yaml
    with:
      push: true
      cache-key: ${{ github.head_ref }}
      sha: ${{ github.event.pull_request.head.sha }}
      upload-s3-assets: true
    secrets: inherit

  triger-and-wait-for-argocd:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'devenv') }}

    runs-on: ubuntu-latest
    needs: [build-docker-images]

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Need the full history to determine if we have a merge commit or not.

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_TO_ASSUME }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region us-east-1 --name gather-ai-aws-stg-us-east-1-a --alias gather-ai-aws-stg-us-east-1-a

      # Once we switch to webhooks, we could opt to remove this.
      - name: Trigger ArgoCD to Deploy
        env:
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |-
          # Cancel existing sync, if there is one. Note that this makes
          # the UI a little funky and pretend that there is a sync going
          # on, but there isn't and triggering a new one works fine.
          kubectl patch application "cc-devenv-$GITHUB_PR_NUMBER" \
            --namespace argocd --type='merge' \
            -p='{"operation": null}' || true

          # Trigger ApplicationSet to create a new application for us,
          # if there isn't one already.
          kubectl patch applicationset grapevine-devenv \
            --namespace argocd --type='merge' \
            -p='{"metadata": {"annotations": {"argocd.argoproj.io/application-set-refresh": "true"}}}'

          # Trigger a new sync, primarily for the case in which we had
          # an existing sync.
          kubectl patch application "cc-devenv-$GITHUB_PR_NUMBER" \
            --namespace argocd --type='merge' \
            -p='{"metadata": {"annotations": {"argocd.argoproj.io/refresh": "hard"}}}' || true

      - name: Wait for ArgoCD Application to be Synced
        continue-on-error: true
        id: wait-for-ready
        env:
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: ./.github/scripts/wait-for-argocd-app-ready.sh "cc-devenv-$GITHUB_PR_NUMBER"

      - name: Update Status
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW_ID: ${{ github.run_id }}
          STATUS: ${{ steps.wait-for-ready.outcome == 'success' && 'success' || 'failure' }}
        run: ./.github/scripts/notify-devenv.sh "$STATUS"

  generate-test-plan:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'devenv') || contains(github.event.pull_request.labels.*.name, 'test-plan') }}

    uses: ./.github/workflows/generate-test-plan.yaml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      pr_head_sha: ${{ github.event.pull_request.head.sha }}
      pr_base_sha: ${{ github.event.pull_request.base.sha }}
      devenv_admin_url: https://cc-devenv-${{ github.event.pull_request.number }}.stg.getgrapevine.ai
      devenv_mcp_url: https://mcp-cc-devenv-${{ github.event.pull_request.number }}.stg.getgrapevine.ai
    secrets:
      CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
